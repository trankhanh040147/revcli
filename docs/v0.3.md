# v0.3 - Short Flags & Vim UX

**Status:** Implemented, In Review
**Target:** Enhanced CLI usability with short flags, Vim-style navigation, and improved yank functionality

---

## üìã Overview

v0.3 focuses on improving developer experience through:
- Short flag aliases for faster CLI usage
- Vim-style keybindings for keyboard-first navigation
- Enhanced yank functionality with multiple options
- Review presets for customizable review styles
- Critical bug fixes for chat mode and yank operations

---

## ‚úÖ Features Implemented

### Short Flag Aliases ‚úÖ

All flags now have concise short aliases:

| Long | Short | Description |
|------|-------|-------------|
| `--staged` | `-s` | Review staged changes |
| `--base` | `-b` | Base branch/commit |
| `--model` | `-m` | Model selection |
| `--force` | `-f` | Skip secret detection |
| `--interactive` | `-i` | Interactive mode |
| `--no-interactive` | `-I` | Non-interactive mode |
| `--api-key` | `-k` | API key |
| `--preset` | `-p` | Review preset |

- [x] Add version flag (`--version`, `-v`)

**Related Files:**
- `cmd/review.go` - Flag definitions
- `cmd/root.go` - Root command flags

---

### Vim-Style Keybindings ‚úÖ

Full Vim-style navigation for keyboard-first UX:

**Navigation:**
- [x] `j` / `‚Üì` - Scroll down one line
- [x] `k` / `‚Üë` - Scroll up one line
- [x] `g` / `Home` - Go to top
- [x] `G` / `End` - Go to bottom
- [x] `Ctrl+d` - Half page down
- [x] `Ctrl+u` - Half page up
- [x] `Ctrl+f` / `PgDn` - Full page down
- [x] `Ctrl+b` / `PgUp` - Full page up

**Search:**
- [x] `/` - Start search
- [x] `n` - Next match
- [x] `N` - Previous match
- [x] `Tab` - Toggle highlight/filter mode
- [x] `Esc` - Exit search

**Help:**
- [x] `?` - Show keybindings overlay (only in reviewing mode)

**Related Files:**
- `internal/ui/model.go` - Key handler implementation
- `internal/ui/search.go` - Search functionality
- `internal/ui/help.go` - Help overlay

---

### Yank to Clipboard ‚úÖ

Multiple yank options for flexible content copying:

- [x] `y` - Yank entire review + chat history to clipboard
- [x] `Y` - Yank only last response (without chat history)
- [x] `yb` - Yank code block (currently yanks last code block)
- [x] Visual feedback when yanked (2-second toast notification)
- [x] Help panel (`?`) documents all yank keybindings

**Implementation Details:**
- `yankReview()` - Copies raw markdown (no ANSI codes) including full conversation
- `yankLastResponse()` - Copies only the most recent assistant response
- `yankCodeBlock()` - Extracts and copies code blocks from markdown

**Related Files:**
- `internal/ui/model.go` - Yank functions (lines 564-685)

---

### Review Presets ‚úÖ

Customizable review styles via presets:

- [x] `--preset <name>` / `-p` - Use predefined review style
- [x] Built-in presets:
  - `quick` - Fast, high-level review
  - `strict` - Comprehensive, detailed review
  - `security` - Focus on security issues
  - `performance` - Performance optimization focus
  - `logic` - Logic and correctness focus
  - `style` - Code style and conventions
  - `typo` - Typo and grammar checking
  - `naming` - Variable and function naming
- [x] Custom presets in `~/.config/plancli/presets/*.yaml`
- [x] **Fuzzy matching** - "Did you mean?" suggestions for typos using Levenshtein distance
  - Prefix matching for very short inputs (1-2 chars, e.g., `se` ‚Üí `security`)
  - Relative similarity for short inputs (3-4 chars)
  - Absolute threshold for longer inputs (5+ chars)
  - Error messages include all available presets (built-in + custom)

**Related Files:**
- `internal/preset/preset.go` - Preset loading, management, and fuzzy matching
- `cmd/review.go` - Preset flag handling

---

## üêõ Bug Fixes

### Yank Issues
- [x] **Fix yank copying ANSI escape codes**
  - **Problem:** Yanked content included terminal color codes (`[38;5;252m`)
  - **Solution:** Use raw markdown sources (`reviewResponse` + `chatHistory`) instead of rendered content
  - **Files:** `internal/ui/model.go` - `yankReview()` function

- [x] **Fix yank only copying initial review**
  - **Problem:** `y` only copied initial review, not chat history
  - **Solution:** Build content from `reviewResponse` + `chatHistory` with proper formatting
  - **Files:** `internal/ui/model.go` - `yankReview()` function

- [x] **Fix Y key handler state machine**
  - **Problem:** `lastKeyWasY` flag not reset when `Y` pressed in wrong state
  - **Solution:** Add unconditional `m.lastKeyWasY = false` after state check
  - **Files:** `internal/ui/model.go` - `case "Y"` handler

### Chat Mode Issues
- [x] **Fix `?` key in chat mode**
  - **Problem:** `?` opened help overlay instead of typing character
  - **Solution:** Only trigger help in `StateReviewing`, let textarea handle `?` in chat mode
  - **Files:** `internal/ui/model.go` - `case "?"` handler

- [x] **Fix Enter key for newlines**
  - **Problem:** Enter immediately sent message, no way to create multi-line input
  - **Solution:** Changed to `Alt+Enter` to send; Enter creates newlines
  - **Files:** `internal/ui/model.go` - `case "alt+enter"` handler, footer help text

- [x] **Fix textarea styling**
  - **Problem:** White/highlighted background on focused textarea
  - **Solution:** Custom border styling + remove cursor line highlighting
  - **Files:** `internal/ui/model.go` - `NewModel()` textarea setup

### UI/UX Issues
- [x] **Fix navigation issues after reviews**
  - **Problem:** Viewport auto-scrolled to bottom after initial review
  - **Solution:** Separate `updateViewport()` (no scroll) and `updateViewportAndScroll()` functions
  - **Files:** `internal/ui/model.go` - Viewport update functions

- [x] **Fix redundant spaces below terminal**
  - **Problem:** Fixed viewport height caused spacing issues
  - **Solution:** Dynamic viewport height calculation via `calculateViewportHeight()`
  - **Files:** `internal/ui/model.go` - `calculateViewportHeight()` function

- [x] **Fix panic when using `--interactive` flag**
  - **Problem:** Renderer initialization failure caused panic
  - **Solution:** Added nil checks and fallback renderer
  - **Files:** `internal/ui/model.go` - `NewModel()`, `internal/ui/view.go` - `RenderMarkdown()`

### Preset Issues
- [x] **Fix preset create multi-word input (Bug #01)**
  - **Problem:** `fmt.Scanln()` only reads first word, breaking multi-word descriptions
  - **Solution:** Replace with `bufio.Reader` for full-line input reading
  - **Files:** `cmd/preset.go` - `runPresetCreate()` function

- [x] **Fix preset error messages missing custom presets (Bug #02)**
  - **Problem:** Error messages only showed built-in presets, not custom ones
  - **Solution:** Updated `ListNames()` to include custom presets via `GetAllPresetNames()`
  - **Files:** `internal/preset/preset.go` - `ListNames()`, `GetAllPresetNames()`

- [x] **Add fuzzy matching for preset typos (Bug #02 enhancement)**
  - **Problem:** No suggestions when users mistype preset names
  - **Solution:** Implemented Levenshtein distance algorithm with prefix matching for short inputs
  - **Files:** `internal/preset/preset.go` - `FindSimilarPresets()`, `levenshteinDistance()`

---

## ‚úÖ Code Block Highlighting & Navigation

Complete code block detection, highlighting, and navigation:

- [x] **Code block detection** - Parse markdown to extract all code blocks with positions
- [x] **Cursor tracking** - Track viewport position and detect code block under cursor
- [x] **Visual highlighting** - Distinct purple border around active code block
- [x] **Navigation** - `[` and `]` keys to navigate between code blocks
- [x] **Smart yank** - `yb` yanks the highlighted code block (not just last)
- [x] **Help panel updates** - All new keybindings documented

**Related Files:**
- `internal/ui/model.go` - Code block parsing, navigation, highlighting
- `internal/ui/view.go` - Code block border styling
- `internal/ui/help.go` - Updated keybindings

## ‚úÖ Chat Enhancements

Enhanced chat mode with request cancellation and prompt history:

- [x] **Request cancellation** - `Ctrl+X` cancels streaming requests while retaining partial response
- [x] **Prompt history** - `Ctrl+P` (previous) and `Ctrl+N` (next) navigate through prompt history
- [x] **History persistence** - Prompts saved automatically when sent

**Related Files:**
- `internal/ui/model.go` - Request cancellation and prompt history handlers

## ‚úÖ Preset Management

Complete preset management via CLI commands:

- [x] **Preset list** - `plancli preset list` shows all built-in and custom presets
- [x] **Preset create** - `plancli preset create` creates new custom presets interactively
- [x] **Preset delete** - `plancli preset delete` removes custom presets
- [x] **Preset show** - `plancli preset show` displays preset details
- [x] **Fuzzy matching & error messages** - Smart typo detection with suggestions
  - "Did you mean?" suggestions when preset name is mistyped
  - Error messages include all available presets (built-in + custom)
  - Examples:
    - `preset show leetcod` ‚Üí "Did you mean 'leetcode'?"
    - `preset show se` ‚Üí "Did you mean 'security'?" (prefix match)
    - `preset show sec` ‚Üí "Did you mean 'security'?" (relative similarity)

**Related Files:**
- `cmd/preset.go` - Preset management commands
- `internal/preset/preset.go` - Fuzzy matching implementation

---

## üîß Technical Notes

### Key Implementation Details

1. **Yank Functions:**
   - All yank functions use raw markdown sources to avoid ANSI escape codes
   - `yankReview()` builds content with markdown formatting for chat history
   - `yankLastResponse()` searches backwards through chat history for last assistant message

2. **Viewport Management:**
   - Dynamic height calculation based on UI state (search bar, yank feedback, chat textarea)
   - Separate scroll behavior for initial review vs. chat updates
   - Filter mode line translation for search navigation

3. **Key Handler State Machine:**
   - `lastKeyWasY` flag for detecting `y` + `b` combo
   - All yank-related keys reset the flag unconditionally to prevent state corruption

4. **Textarea Styling:**
   - Custom `FocusedStyle.Base` and `BlurredStyle.Base` for border colors
   - Empty `CursorLine` styles to remove row highlighting

5. **Preset Fuzzy Matching:**
   - Levenshtein distance algorithm for typo detection
   - Prefix matching for very short inputs (1-2 chars)
   - Relative similarity threshold for short inputs (3-4 chars)
   - Absolute threshold for longer inputs (5+ chars)
   - Case-insensitive matching

---

## üìÅ Related Files

### Core Implementation
- `internal/ui/model.go` - Main UI model, key handlers, yank functions
- `internal/ui/view.go` - Renderer with nil checks
- `internal/ui/help.go` - Help overlay with all keybindings
- `internal/ui/search.go` - Search functionality with filter mode

### CLI & Configuration
- `cmd/review.go` - Review command with short flags and preset support
- `cmd/root.go` - Root command with version flag
- `internal/preset/preset.go` - Preset loading and management

### Build & Documentation
- `Makefile` - Added `uninstall` target
- `docs/DEVELOPMENT.md` - Main development roadmap

---

## üîó Sync with DEVELOPMENT.md

This file is synced with `docs/DEVELOPMENT.md` section "v0.3 - Short Flags & Vim UX".

**Last Synced:** Based on current DEVELOPMENT.md state

**Key Sections:**
- Features Implemented (lines 79-110 in docs/DEVELOPMENT.md)
- Remaining Features (lines 112-123 in docs/DEVELOPMENT.md)
- Known Bugs (lines 273-282 in docs/DEVELOPMENT.md)

---

## üìä Progress Summary

**Completed:**
- ‚úÖ Short Flag Aliases (9 flags + version)
- ‚úÖ Vim-Style Keybindings (navigation, search, help)
- ‚úÖ Yank to Clipboard (3 variants)
- ‚úÖ Review Presets (8 built-in + custom + fuzzy matching)
- ‚úÖ (IN REVIEW) Code lock Highlighting & Navigation (6 features)
- ‚úÖ (IN REVIEW) Chat Enhancements (request cancellation, prompt history)
- ‚úÖ (IN REVIEW) Preset Management (4 commands + fuzzy matching)
- ‚úÖ 10 Bug Fixes (including Bug #01 and Bug #02)

**Overall Progress:** ‚úÖ 100% complete (IN REVIEW) 

---

## üéØ Next Steps

1. ‚úÖ All v0.3 features completed
2. Final testing and validation
3. Prepare for v0.4 planning

