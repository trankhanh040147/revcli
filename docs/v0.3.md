# v0.3 - Short Flags & Vim UX

**Status:** In Progress  
**Target:** Enhanced CLI usability with short flags, Vim-style navigation, and improved yank functionality

---

## üìã Overview

v0.3 focuses on improving developer experience through:
- Short flag aliases for faster CLI usage
- Vim-style keybindings for keyboard-first navigation
- Enhanced yank functionality with multiple options
- Review presets for customizable review styles
- Critical bug fixes for chat mode and yank operations

---

## ‚úÖ Features Implemented

### Short Flag Aliases ‚úÖ

All flags now have concise short aliases:

| Long | Short | Description |
|------|-------|-------------|
| `--staged` | `-s` | Review staged changes |
| `--base` | `-b` | Base branch/commit |
| `--model` | `-m` | Model selection |
| `--force` | `-f` | Skip secret detection |
| `--interactive` | `-i` | Interactive mode |
| `--no-interactive` | `-I` | Non-interactive mode |
| `--api-key` | `-k` | API key |
| `--preset` | `-p` | Review preset |

- [x] Add version flag (`--version`, `-v`)

**Related Files:**
- `cmd/review.go` - Flag definitions
- `cmd/root.go` - Root command flags

---

### Vim-Style Keybindings ‚úÖ

Full Vim-style navigation for keyboard-first UX:

**Navigation:**
- [x] `j` / `‚Üì` - Scroll down one line
- [x] `k` / `‚Üë` - Scroll up one line
- [x] `g` / `Home` - Go to top
- [x] `G` / `End` - Go to bottom
- [x] `Ctrl+d` - Half page down
- [x] `Ctrl+u` - Half page up
- [x] `Ctrl+f` / `PgDn` - Full page down
- [x] `Ctrl+b` / `PgUp` - Full page up

**Search:**
- [x] `/` - Start search
- [x] `n` - Next match
- [x] `N` - Previous match
- [x] `Tab` - Toggle highlight/filter mode
- [x] `Esc` - Exit search

**Help:**
- [x] `?` - Show keybindings overlay (only in reviewing mode)

**Related Files:**
- `internal/ui/model.go` - Key handler implementation
- `internal/ui/search.go` - Search functionality
- `internal/ui/help.go` - Help overlay

---

### Yank to Clipboard ‚úÖ

Multiple yank options for flexible content copying:

- [x] `y` - Yank entire review + chat history to clipboard
- [x] `Y` - Yank only last response (without chat history)
- [x] `yb` - Yank code block (currently yanks last code block)
- [x] Visual feedback when yanked (2-second toast notification)
- [x] Help panel (`?`) documents all yank keybindings

**Implementation Details:**
- `yankReview()` - Copies raw markdown (no ANSI codes) including full conversation
- `yankLastResponse()` - Copies only the most recent assistant response
- `yankCodeBlock()` - Extracts and copies code blocks from markdown

**Related Files:**
- `internal/ui/model.go` - Yank functions (lines 564-685)

---

### Review Presets ‚úÖ

Customizable review styles via presets:

- [x] `--preset <name>` / `-p` - Use predefined review style
- [x] Built-in presets:
  - `quick` - Fast, high-level review
  - `strict` - Comprehensive, detailed review
  - `security` - Focus on security issues
  - `performance` - Performance optimization focus
  - `logic` - Logic and correctness focus
  - `style` - Code style and conventions
  - `typo` - Typo and grammar checking
  - `naming` - Variable and function naming
- [x] Custom presets in `~/.config/revcli/presets/*.yaml`

**Related Files:**
- `internal/preset/preset.go` - Preset loading and management
- `cmd/review.go` - Preset flag handling

---

## üêõ Bug Fixes

### Yank Issues
- [x] **Fix yank copying ANSI escape codes**
  - **Problem:** Yanked content included terminal color codes (`[38;5;252m`)
  - **Solution:** Use raw markdown sources (`reviewResponse` + `chatHistory`) instead of rendered content
  - **Files:** `internal/ui/model.go` - `yankReview()` function

- [x] **Fix yank only copying initial review**
  - **Problem:** `y` only copied initial review, not chat history
  - **Solution:** Build content from `reviewResponse` + `chatHistory` with proper formatting
  - **Files:** `internal/ui/model.go` - `yankReview()` function

- [x] **Fix Y key handler state machine**
  - **Problem:** `lastKeyWasY` flag not reset when `Y` pressed in wrong state
  - **Solution:** Add unconditional `m.lastKeyWasY = false` after state check
  - **Files:** `internal/ui/model.go` - `case "Y"` handler

### Chat Mode Issues
- [x] **Fix `?` key in chat mode**
  - **Problem:** `?` opened help overlay instead of typing character
  - **Solution:** Only trigger help in `StateReviewing`, let textarea handle `?` in chat mode
  - **Files:** `internal/ui/model.go` - `case "?"` handler

- [x] **Fix Enter key for newlines**
  - **Problem:** Enter immediately sent message, no way to create multi-line input
  - **Solution:** Changed to `Alt+Enter` to send; Enter creates newlines
  - **Files:** `internal/ui/model.go` - `case "alt+enter"` handler, footer help text

- [x] **Fix textarea styling**
  - **Problem:** White/highlighted background on focused textarea
  - **Solution:** Custom border styling + remove cursor line highlighting
  - **Files:** `internal/ui/model.go` - `NewModel()` textarea setup

### UI/UX Issues
- [x] **Fix navigation issues after reviews**
  - **Problem:** Viewport auto-scrolled to bottom after initial review
  - **Solution:** Separate `updateViewport()` (no scroll) and `updateViewportAndScroll()` functions
  - **Files:** `internal/ui/model.go` - Viewport update functions

- [x] **Fix redundant spaces below terminal**
  - **Problem:** Fixed viewport height caused spacing issues
  - **Solution:** Dynamic viewport height calculation via `calculateViewportHeight()`
  - **Files:** `internal/ui/model.go` - `calculateViewportHeight()` function

- [x] **Fix panic when using `--interactive` flag**
  - **Problem:** Renderer initialization failure caused panic
  - **Solution:** Added nil checks and fallback renderer
  - **Files:** `internal/ui/model.go` - `NewModel()`, `internal/ui/view.go` - `RenderMarkdown()`

---

## üìù Remaining Features

### Code Block Highlighting
- [ ] Show cursor while navigating
- [ ] Detect code block under cursor based on viewport position
- [ ] Highlight active code block with distinct border
- [ ] Navigate between code blocks
- [ ] Show contextual hint "Press yb to copy" when code block is focused
- [ ] `yb` yanks the highlighted block (not just first/last block)
- [ ] Stop request, still retain the last request
- [ ] Able to navigate through previous request prompt while typing current prompt
- [ ] Add flag to manage presets config

---

## üîß Technical Notes

### Key Implementation Details

1. **Yank Functions:**
   - All yank functions use raw markdown sources to avoid ANSI escape codes
   - `yankReview()` builds content with markdown formatting for chat history
   - `yankLastResponse()` searches backwards through chat history for last assistant message

2. **Viewport Management:**
   - Dynamic height calculation based on UI state (search bar, yank feedback, chat textarea)
   - Separate scroll behavior for initial review vs. chat updates
   - Filter mode line translation for search navigation

3. **Key Handler State Machine:**
   - `lastKeyWasY` flag for detecting `y` + `b` combo
   - All yank-related keys reset the flag unconditionally to prevent state corruption

4. **Textarea Styling:**
   - Custom `FocusedStyle.Base` and `BlurredStyle.Base` for border colors
   - Empty `CursorLine` styles to remove row highlighting

---

## üìÅ Related Files

### Core Implementation
- `internal/ui/model.go` - Main UI model, key handlers, yank functions
- `internal/ui/view.go` - Renderer with nil checks
- `internal/ui/help.go` - Help overlay with all keybindings
- `internal/ui/search.go` - Search functionality with filter mode

### CLI & Configuration
- `cmd/review.go` - Review command with short flags and preset support
- `cmd/root.go` - Root command with version flag
- `internal/preset/preset.go` - Preset loading and management

### Build & Documentation
- `Makefile` - Added `uninstall` target
- `docs/DEVELOPMENT.md` - Main development roadmap

---

## üîó Sync with DEVELOPMENT.md

This file is synced with `docs/DEVELOPMENT.md` section "v0.3 - Short Flags & Vim UX".

**Last Synced:** Based on current DEVELOPMENT.md state

**Key Sections:**
- Features Implemented (lines 79-110 in docs/DEVELOPMENT.md)
- Remaining Features (lines 112-123 in docs/DEVELOPMENT.md)
- Known Bugs (lines 273-282 in docs/DEVELOPMENT.md)

---

## üìä Progress Summary

**Completed:**
- ‚úÖ Short Flag Aliases (9 flags + version)
- ‚úÖ Vim-Style Keybindings (navigation, search, help)
- ‚úÖ Yank to Clipboard (3 variants)
- ‚úÖ Review Presets (8 built-in + custom)
- ‚úÖ 8 Bug Fixes

**Remaining:**
- ‚è≥ Code Block Highlighting (9 features)
- ‚è≥ Preset management flag

**Overall Progress:** ~85% complete

---

## üéØ Next Steps

1. Complete Code Block Highlighting features
2. Add preset management flag
3. Final testing and documentation
4. Prepare for v0.4 planning

