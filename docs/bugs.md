# Known Bugs

> Track and fix these issues

| Bug                                                                       | Status | Notes                                                                                                                                                                                                                                  |                                         |
|---------------------------------------------------------------------------|--------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------|
| Navigation issues after reviews                                           | Fixed  | No longer auto-scrolls to bottom; users read from top                                                                                                                                                                                  |                                         |
| Redundant spaces below terminal                                           | Fixed  | Dynamic viewport height calculation based on UI state                                                                                                                                                                                  |                                         |
| Yank only copies initial review                                           | Fixed  | Now yanks full content including chat history                                                                                                                                                                                          |                                         |
| Code block navigation removed                                             | Fixed  | Code block navigation (`[`, `]`, `yb`) removed in v0.3.1; deferred to v0.6 for complexity/UX reasons                                                                                                                                   |                                         |
| Panic when using --interactive flag                                       | Fixed  | Added nil checks for renderer fallback                                                                                                                                                                                                 |                                         |
| Can't type `?` in chat mode                                               | Fixed  | `?` now only triggers help in reviewing mode, passes through in chat                                                                                                                                                                   |                                         |
| Can't press Enter for newline in chat                                     | Fixed  | Changed to `Alt+Enter` to send; Enter creates newlines                                                                                                                                                                                 |                                         |
| Textarea has white/highlighted background                                 | Fixed  | Custom textarea styling with rounded borders                                                                                                                                                                                           |                                         |
| Preset create fails with multi-word descriptions                          | Fixed  | `fmt.Scanln()` only reads first word; replaced with `bufio.Reader` for full-line input                                                                                                                                                 |                                         |
| Multiple stdin readers cause data loss                                    | Fixed  | Creating multiple `bufio.NewReader(os.Stdin)` instances causes buffered data loss when input is piped. Fixed by creating a single reader and reusing it.                                                                               |                                         |
| IS01: Users can't edit custom presets                                     | Fixed  | Added `preset edit` command to allow editing custom presets interactively                                                                                                                                                              |                                         |
| IS02: Missing feature to edit preset in command line or manually          | Fixed  | Added `preset edit` command and `preset open` command for manual editing                                                                                                                                                               |                                         |
| IS03: Missing feature to open preset folder/file                          | Fixed  | Added `preset open` (opens in editor/file manager) and `preset path` (shows path) commands                                                                                                                                             |                                         |
| IS04: Missing feature to set default preset                               | Fixed  | Added `preset default` command and config.yaml support for default preset                                                                                                                                                              |                                         |
| IS05: Preset gets appended to system prompt, should optionally replace it | Fixed  | Added `replace` field to preset YAML and `--preset-replace` flag to review command                                                                                                                                                     |                                         |
| Flag redefined panic in preset command                                    | Fixed  | Duplicate flag definitions in `init()` function caused panic. Fixed by removing duplicate flag registrations. Always check for duplicate flag definitions when adding new flags.                                                       |                                         |
| IS06: No helper found when run `rv review -h`                             | Fixed  | Added `--preset-replace` flag to help examples in command Long description                                                                                                                                                             |                                         |
| IS07: Flag is too long, not great for typing                              | Fixed  | Added short alias `-R` for `--preset-replace` flag using `BoolVarP`                                                                                                                                                                    |                                         |
| IS08: Missing feature: edit system prompt                                 | Fixed  | Added `preset system` command with `show/edit/reset` subcommands. System prompt can be customized via `~/.config/plancli/presets/system.yaml`                                                                                           |                                         |
| IS09: Fail to edit when enter a different name                            | Fixed  | Disabled name editing in `preset edit` command. Name is now read-only to prevent data loss.                                                                                                                                            |                                         |
| IS10: Not enter default value when editing                                | Fixed  | Improved default value prompts with clearer instructions and explicit current value display.                                                                                                                                           |                                         |
| IS11: Can not move cursor up and down when edit prompt                    | Fixed  | Replaced line-by-line stdin input with external editor (`$EDITOR` or `vi` fallback) for multiline prompt editing.                                                                                                                      |                                         |
| IS12: Preset files when saved got `\n` instead of breaks                  | Fixed  | Added custom `MarshalYAML()` method to `Preset` struct to use literal block scalars (`                                                                                                                                                 | `) for multiline prompts in YAML files. |
| Manual layout calculation in help overlay                                 | Fixed  | Replaced manual padding calculation with `lipgloss.Place()` for proper centering.                                                                                                                                                      |
| Swallowed renderer initialization error                                   | Fixed  | Added error logging to `os.Stderr` before fallback to maintain visibility during development.                                                                                                                                          |
| Inconsistent method receivers in Model                                    | Fixed  | Converted all state-mutating methods from value receivers to pointer receivers for consistency and correctness.                                                                                                                        |
| Stringly-typed message fields                                             | Fixed  | Added typed constants (`YankTypeReview`, `YankTypeLastResponse`, `ChatRoleUser`, `ChatRoleAssistant`) to replace raw string literals.                                                                                                  |
| Incomplete review request: core logic missing                             | Fixed  | Process issue: missing new files in diff. TUI refactor files (`update.go`, `view.go`) now included. Core logic properly decomposed.                                                                                                    |
| Inconsistent pointer receiver usage in constructor                        | Fixed  | Changed `NewModel` to return `*Model` instead of `Model`. Aligns with idiomatic Go for mutable types and prevents accidental copies.                                                                                                   |
| Stringly-typed enum (ChatRole, YankType)                                  | Fixed  | Replaced string constants with typed enums (`type ChatRole int`, `type YankType int`). Enables compile-time type safety and prevents invalid assignments.                                                                              |
| Monolithic Model file                                                     | Fixed  | Split `startReview` into `model_review.go`, viewport helpers into `viewport.go`. `model.go` now focused on struct definition and constructor only.                                                                                     |
| Incorrect integer-to-string conversion in RenderSecretWarning             | Fixed  | Replaced `string(rune(s.Line + '0'))` with `strconv.Itoa(s.Line)`. Also replaced custom `itoa()` function with `strconv.Itoa()`. Never use rune arithmetic for numeric formatting.                                                     |
| Direct stdout writes in RunSimple                                         | Fixed  | Refactored `RunSimple` to accept `io.Writer` parameter. Enables testing and output redirection. Library functions should accept `io.Writer`, only CLI commands bind to `os.Stdout`.                                                    |
| Unused Content field in YankMsg                                           | Fixed  | Removed `Content` field from `YankMsg`, now intent-only with `Type` field. Message buses should pass intents, not duplicate large content already in model state.                                                                      |
| Magic number in RenderLoadingDots modulo                                  | Fixed  | Replaced `dots[tick%4]` with `dots[tick%len(dots)]`. Never hardcode slice lengths in modulo/indexing operations.                                                                                                                       |
| File size: update.go exceeds 200-line limit                               | Fixed  | Split into state-specific files: `update_reviewing.go`, `update_chatting.go`, `update_searching.go`, `update_filelist.go`, `update_help.go`, `update_prune.go`. Main `update.go` now ~150 lines.                                       |
| os.Exit in command logic (printSecretsWarning)                            | Fixed  | Changed to return `ErrSecretsDetected` error. Only `main.go` calls `os.Exit`.                                                                                                                                                          |
| Blocking I/O in tea.Cmd (os.Getenv inside pruneFileCmd)                   | Fixed  | Added `apiKey` field to Model, inject as parameter to `pruneFileCmd`. Dependency injection pattern for all tea.Cmd functions.                                                                                                          |
| File size: builder.go exceeds 200-line limit                              | Fixed  | Extracted formatters (`Summary`, `DetailedSummary`, `formatBytes`) to `formatters.go`.                                                                                                                                                 |
| File size: model.go exceeds 200-line limit                                | Fixed  | Extracted `RunSimple` to `simple_run.go`, moved `ChatMessage`/`ChatRole` to `chat.go`.                                                                                                                                                 |
| Function size: runReview exceeds 50-line limit                            | Fixed  | Extracted helpers: `loadActivePreset`, `buildReviewContext`, `initializeAPIClient` to `review_helpers.go`.                                                                                                                             |
| Duplicated state transition logic                                         | Fixed  | Added `returnToPreviousState()` helper method, replaced 5 duplicated occurrences.                                                                                                                                                      |
| Duplicated help strings                                                   | Fixed  | Use `RenderCompactHelp(state)` in `viewFooter()` and `viewFileList()`. Centralized in `help.go`.                                                                                                                                       |
| Ambiguous key binding (FileList and PruneFile both "i")                   | Fixed  | Renamed `PruneFile` to `FileListPrune` for clarity. Contextual handling remains.                                                                                                                                                       |
| Hardcoded environment variable name                                       | Fixed  | Created `internal/config/constants.go` with `EnvGeminiAPIKey` constant. All references updated.                                                                                                                                        |
| Inconsistent UI rendering (fmt.Println in command)                        | Fixed  | Created `review_output.go` with writer-based helpers: `printReviewHeader`, `printContextSummary`, `printSecretsWarning`.                                                                                                               |
| Streaming API blocks UI in model_review.go                                | Fixed  | Refactored `startReview()` to use goroutine + channel pattern. Streaming chunks sent via `StreamChunkMsg`, completion via `StreamDoneMsg`. UI remains responsive during streaming.                                                     |
| Non-nil return with error in builder.go                                   | Fixed  | Created `SecretsError` type and `ErrSecretsDetected` sentinel. `Build()` now returns `(nil, SecretsError{Matches: ...})` instead of non-nil context with error.                                                                        |
| Redundant nil checks for PrunedFiles                                      | Fixed  | Removed redundant `PrunedFiles == nil` checks from `update.go`, `update_filelist.go`, and `file_list.go`. Contract guarantees non-nil initialization in `builder.go:91`.                                                               |
| Hardcoded error type check in cmd/review.go                               | Fixed  | Replaced struct field check with `errors.As()` to extract `SecretsError` and access `Matches`. Uses proper error type checking instead of checking struct fields.                                                                      |
| Function size: updateNonKeyMsg exceeds 80-line limit                      | Fixed  | Extracted message handlers into dedicated methods: `handleStreamMessages`, `handleReviewMessages`, `handleChatMessages`, `handleYankMessages`, `handlePruneMessages`, `handleWindowSize`, `handleSpinnerTick`. Function now ~56 lines. |
| Stateful context management in chat cancellation                          | Fixed  | Changed from storing `ctx` in model to creating context per command. Store only `activeCancel` function for currently active command. Clear `activeCancel` when commands complete or are cancelled.                                    |
| Hardcoded duration (300ms) for yank timeout                               | Fixed  | Added `YankChordTimeout` constant (300ms) to `internal/ui/constants.go`. Replaced magic number in `update_reviewing.go`.                                                                                                               |
| Repetitive logic in prompt history navigation                             | Fixed  | Created `navigatePromptHistory(direction int)` helper method. Replaced duplicated `PrevPrompt`/`NextPrompt` logic with calls to helper.                                                                                                |

---

